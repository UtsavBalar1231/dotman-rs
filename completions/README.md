# Dotman Shell Completions

This directory contains shell completion scripts for `dot` (dotman), providing intelligent tab completion for all commands and their arguments.

## Overview

Dotman provides two types of completions:

1. **Basic Completions**: Static completions generated automatically by clap
2. **Enhanced Completions**: Dynamic completions with context-aware suggestions

## Supported Shells

- **Bash** (4.1+)
- **Zsh** (5.0+)
- **Fish** (3.0+)
- **PowerShell** (basic only)
- **Elvish** (basic only)

## Quick Installation

The easiest way to install completions is using the provided install script:

```bash
# Install enhanced completions (recommended)
./scripts/install-completions.sh bash
./scripts/install-completions.sh zsh
./scripts/install-completions.sh fish

# Install basic completions
./scripts/install-completions.sh bash basic
./scripts/install-completions.sh zsh basic
./scripts/install-completions.sh fish basic
```

## Files

### Basic Completions (Generated by clap)
- `dot.bash` - Bash completion
- `_dot` - Zsh completion
- `dot.fish` - Fish completion
- `dot.ps1` - PowerShell completion
- `dot.elv` - Elvish completion

### Enhanced Completions (Hand-crafted)
- `dot-enhanced.bash` - Enhanced Bash completion
- `_dot-enhanced` - Enhanced Zsh completion
- `dot-enhanced.fish` - Enhanced Fish completion

## Features

### Basic Completions
- Command name completion
- Subcommand completion
- Static flag and option completion
- Help text for commands

### Enhanced Completions
All features of basic completions plus:

- **Dynamic Branch Completion**: Tab-complete branch names from your repository
- **Remote Completion**: Tab-complete configured remote names
- **Commit Hash Completion**: Tab-complete recent commit hashes (last 20)
- **Config Key Completion**: Tab-complete configuration keys with descriptions
- **File Status Awareness**:
  - Show untracked files for `dot add`
  - Show tracked files for `dot rm --cached`
- **Context-Aware Filtering**:
  - Exclude current branch from `dot branch delete` suggestions
  - Show appropriate completions based on command context
- **Smart Argument Completion**:
  - Remote names for push/pull first argument
  - Branch names for push/pull second argument
  - Commit/branch/HEAD for checkout, reset, show, diff

## Manual Installation

### Bash

#### Option 1: User-specific installation
```bash
# Create completions directory if it doesn't exist
mkdir -p ~/.local/share/bash-completion/completions/

# Copy the completion file (choose one)
cp completions/dot-enhanced.bash ~/.local/share/bash-completion/completions/dot  # Enhanced
cp completions/dot.bash ~/.local/share/bash-completion/completions/dot           # Basic

# Ensure bash-completion is loaded in ~/.bashrc
echo 'source ~/.local/share/bash-completion/completions/dot' >> ~/.bashrc

# Reload shell
source ~/.bashrc
```

#### Option 2: System-wide installation (requires sudo)
```bash
# Copy to system directory (choose one)
sudo cp completions/dot-enhanced.bash /usr/share/bash-completion/completions/dot  # Enhanced
sudo cp completions/dot.bash /usr/share/bash-completion/completions/dot           # Basic
```

### Zsh

```bash
# Create site-functions directory if it doesn't exist
mkdir -p ~/.local/share/zsh/site-functions/

# Copy the completion file (choose one)
cp completions/_dot-enhanced ~/.local/share/zsh/site-functions/_dot  # Enhanced
cp completions/_dot ~/.local/share/zsh/site-functions/_dot           # Basic

# Add to ~/.zshrc if not present
cat >> ~/.zshrc << 'EOF'
# Add local completions to fpath
fpath=(~/.local/share/zsh/site-functions $fpath)
autoload -Uz compinit && compinit
EOF

# Rebuild completion cache
rm -f ~/.zcompdump && compinit
```

### Fish

```bash
# Create completions directory if it doesn't exist
mkdir -p ~/.config/fish/completions/

# Copy the completion file (choose one)
cp completions/dot-enhanced.fish ~/.config/fish/completions/dot.fish  # Enhanced
cp completions/dot.fish ~/.config/fish/completions/dot.fish           # Basic

# Fish automatically loads completions from ~/.config/fish/completions/
```

### PowerShell

```powershell
# Add to your PowerShell profile
# Find profile location with: $PROFILE
notepad $PROFILE

# Add this line to the profile
. /path/to/dotman/completions/dot.ps1
```

### Elvish

```elvish
# Add to ~/.elvish/rc.elv
eval (cat /path/to/dotman/completions/dot.elv)
```

## Generating/Updating Completions

Basic completions are generated from the clap command definitions:

```bash
# Generate all basic completions
./scripts/generate-completions.sh

# Or generate for a specific shell using the dot binary
dot completion bash > completions/dot.bash
dot completion zsh > completions/_dot
dot completion fish > completions/dot.fish
```

Enhanced completions are hand-crafted and need manual updates when commands change.

## Testing Completions

### Bash
```bash
# After installation, test with
dot <TAB><TAB>           # Should show all commands
dot ch<TAB>              # Should complete to 'checkout'
dot checkout <TAB><TAB>  # Should show branches and commits
dot config user.<TAB>    # Should show user.name and user.email
```

### Zsh
```zsh
# After installation, test with
dot <TAB>                # Should show commands with descriptions
dot checkout <TAB>       # Should show branches, commits, and HEAD
dot branch delete <TAB>  # Should show branches except current
```

### Fish
```fish
# After installation, test with
dot <TAB>                # Should show commands with descriptions
dot checkout <TAB>       # Should show branches and commits
dot config <TAB>         # Should show config keys with descriptions
```

## Troubleshooting

### Completions not working

1. **Check if completion system is loaded**:
   - Bash: Run `complete -p | grep dot`
   - Zsh: Run `echo $fpath` and check if your completion directory is listed
   - Fish: Run `complete -C "dot "`

2. **Reload your shell**:
   ```bash
   # Bash
   source ~/.bashrc

   # Zsh
   source ~/.zshrc
   # Or rebuild completion cache
   rm ~/.zcompdump && exec zsh

   # Fish
   exec fish
   ```

3. **Check file permissions**:
   ```bash
   ls -la ~/.local/share/bash-completion/completions/dot
   ls -la ~/.local/share/zsh/site-functions/_dot
   ls -la ~/.config/fish/completions/dot.fish
   ```

4. **Verify dotman is installed and working**:
   ```bash
   which dot
   dot --version
   ```

### Enhanced completions showing errors

Enhanced completions require a working dotman repository. If you see errors:

1. Initialize a dotman repository first:
   ```bash
   dot init
   ```

2. Check if commands work manually:
   ```bash
   dot branch list
   dot remote list
   dot status
   ```

### Zsh completions not updating

Zsh caches completions. To force a refresh:
```bash
rm -f ~/.zcompdump*
compinit
```

## Contributing

When adding new commands or modifying existing ones:

1. Update the Rust code with proper clap attributes
2. Regenerate basic completions: `./scripts/generate-completions.sh`
3. Update enhanced completions manually:
   - `completions/dot-enhanced.bash`
   - `completions/_dot-enhanced`
   - `completions/dot-enhanced.fish`
4. Test all shells to ensure completions work correctly

## License

Same as the main dotman project.
