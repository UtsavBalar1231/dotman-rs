# Contributor: Utsav Balar <utsavbalar1231@gmail.com>
# Maintainer: Utsav Balar <utsavbalar1231@gmail.com>
pkgname=dotman
pkgver=0.0.1
pkgrel=0
pkgdesc="High-performance dotfiles manager with git-like semantics"
url="https://github.com/UtsavBalar1231/dotman"
arch="x86_64 aarch64"
license="MIT"
makedepends="
	cargo
	cargo-auditable
	help2man
	"
checkdepends="cargo"
subpackages="
	$pkgname-doc
	$pkgname-bash-completion
	$pkgname-zsh-completion
	$pkgname-fish-completion
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/UtsavBalar1231/dotman/archive/refs/tags/v$pkgver.tar.gz"
options="net"  # Required for cargo to fetch dependencies

# Build configuration
export CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1
export CARGO_PROFILE_RELEASE_LTO=true
export CARGO_PROFILE_RELEASE_OPT_LEVEL=3
export CARGO_PROFILE_RELEASE_STRIP=true

prepare() {
	default_prepare
	cd "$builddir"
	cargo fetch --locked
}

build() {
	cd "$builddir"

	# Build with cargo-auditable for supply chain security
	if command -v cargo-auditable >/dev/null 2>&1; then
		cargo auditable build --release --locked --all-features
	else
		cargo build --release --locked --all-features
	fi
}

check() {
	cd "$builddir"
	cargo test --release --locked --all-features
}

package() {
	cd "$builddir"

	# Install the main binary
	install -Dm755 target/release/dot "$pkgdir"/usr/bin/dot

	# Install documentation
	install -Dm644 README.md "$pkgdir"/usr/share/doc/$pkgname/README.md

	# Generate shell completions
	mkdir -p completions
	./target/release/dot completion bash > completions/dot.bash
	./target/release/dot completion zsh > completions/_dot
	./target/release/dot completion fish > completions/dot.fish

	# Install shell completions
	install -Dm644 completions/dot.bash \
		"$pkgdir"/usr/share/bash-completion/completions/dot
	install -Dm644 completions/_dot \
		"$pkgdir"/usr/share/zsh/site-functions/_dot
	install -Dm644 completions/dot.fish \
		"$pkgdir"/usr/share/fish/vendor_completions.d/dot.fish

	# Generate and install man page
	help2man --no-info --name="high-performance dotfiles manager" \
		--version-string="$pkgver" ./target/release/dot > dot.1
	install -Dm644 dot.1 "$pkgdir"/usr/share/man/man1/dot.1
}

sha512sums="SKIP"  # Updated by CI/release workflow
