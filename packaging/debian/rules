#!/usr/bin/make -f
# Debian rules file for dotman
# Uses direct cargo build instead of dh-cargo for reliability

export DH_VERBOSE = 1
export DEB_BUILD_MAINT_OPTIONS = hardening=+all

# Disable network access during build
export CARGO_NET_OFFLINE = true

%:
	dh $@

override_dh_auto_configure:
	# Verify Cargo.lock exists
	test -f Cargo.lock

override_dh_auto_build:
	cargo build --release --all-features --locked

override_dh_auto_test:
	cargo test --release --all-features --locked

override_dh_auto_install:
	# Install binary
	install -Dm755 target/release/dot debian/dotman/usr/bin/dot

	# Generate and install shell completions
	mkdir -p debian/dotman/usr/share/bash-completion/completions
	target/release/dot completion bash > debian/dotman/usr/share/bash-completion/completions/dot

	mkdir -p debian/dotman/usr/share/zsh/vendor-completions
	target/release/dot completion zsh > debian/dotman/usr/share/zsh/vendor-completions/_dot

	mkdir -p debian/dotman/usr/share/fish/vendor_completions.d
	target/release/dot completion fish > debian/dotman/usr/share/fish/vendor_completions.d/dot.fish

	# Generate and install man page
	mkdir -p debian/dotman/usr/share/man/man1
	help2man --no-info --name="high-performance dotfiles manager" \
		--version-string="$$(grep '^version = ' Cargo.toml | head -1 | sed 's/.*\"\(.*\)\".*/\1/')" \
		target/release/dot > debian/dotman/usr/share/man/man1/dot.1

	# Install documentation
	mkdir -p debian/dotman/usr/share/doc/dotman
	cp README.md debian/dotman/usr/share/doc/dotman/

override_dh_auto_clean:
	rm -rf target/

override_dh_strip:
	dh_strip

override_dh_compress:
	dh_compress -X.rs -X.toml
