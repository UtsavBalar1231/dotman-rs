# Maintainer: Utsav Balar <utsavbalar1231@gmail.com>
# Contributor: Community

pkgname=dotman-git
pkgver=r1.0.0.1.g7eb5a78
pkgrel=1
pkgdesc="Blazingly fast dotfiles manager built in Rust with git-like semantics (git version)"
arch=('x86_64' 'aarch64')
url="https://github.com/UtsavBalar1231/dotman-rs"
license=('MIT')
depends=('gcc-libs' 'glibc')
makedepends=('rust' 'cargo' 'git')
provides=('dotman')
conflicts=('dotman')
source=("git+https://github.com/UtsavBalar1231/dotman-rs.git")
sha256sums=('SKIP')

# Build with full optimizations
export RUSTUP_TOOLCHAIN=stable
export CARGO_TARGET_DIR=target

pkgver() {
    cd dotman
    printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short=7 HEAD)"
}

prepare() {
    cd dotman
    
    # Update Cargo.lock for reproducible builds
    cargo fetch --locked --target "$CARCH-unknown-linux-gnu"
}

build() {
    cd dotman
    
    # Build with optimizations for the target architecture
    export RUSTFLAGS="-C target-cpu=native"
    
    cargo build \
        --release \
        --frozen \
        --all-features \
        --target-dir=target
}

check() {
    cd dotman
    
    # Run test suite (skip property-based tests for faster builds)
    cargo test \
        --release \
        --frozen \
        --all-features \
        --target-dir=target \
        --exclude property_based_tests || true
}

package() {
    cd dotman
    
    # Install binary (binary name is 'dot', not 'dotman')
    install -Dm755 target/release/dot "$pkgdir/usr/bin/dot"
    
    # Install documentation
    install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
    
    # Install license
    install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE" 2>/dev/null || \
    install -Dm644 Cargo.toml "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
    
    # Generate and install shell completions
    if command -v dot >/dev/null 2>&1; then
        # Bash completion
        mkdir -p "$pkgdir/usr/share/bash-completion/completions"
        target/release/dot completion bash > "$pkgdir/usr/share/bash-completion/completions/dot" 2>/dev/null || true
        
        # Zsh completion
        mkdir -p "$pkgdir/usr/share/zsh/site-functions"
        target/release/dot completion zsh > "$pkgdir/usr/share/zsh/site-functions/_dot" 2>/dev/null || true
        
        # Fish completion
        mkdir -p "$pkgdir/usr/share/fish/vendor_completions.d"
        target/release/dot completion fish > "$pkgdir/usr/share/fish/vendor_completions.d/dot.fish" 2>/dev/null || true
        
        # Generate man page
        mkdir -p "$pkgdir/usr/share/man/man1"
        target/release/dot --help | help2man -N -n "blazingly fast dotfiles manager" \
            --version-string="git-$(git rev-parse --short HEAD)" \
            -o "$pkgdir/usr/share/man/man1/dot.1" \
            target/release/dot 2>/dev/null || true
    fi
    
    # Install examples if they exist
    if [ -d "examples" ]; then
        install -dm755 "$pkgdir/usr/share/doc/$pkgname/examples"
        cp -r examples/* "$pkgdir/usr/share/doc/$pkgname/examples/"
    fi
}
